<!DOCTYPE HTML>
<html>
<head>
    <title>File watch (based on Flask-SocketIO)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function() {
            // Connect to the Socket.IO server.
            // The connection URL has the following format, relative to the current page:
            //     http[s]://<domain>:<port>[/<namespace>]
            var socket = io('http://localhost:8899/');

            // Event handler for new connections.
            // The callback function is invoked when a connection with the
            // server is established.
            socket.on('connect', function() {
            });

            // Event handler for server sent data.
            // The callback function is invoked whenever the server emits data
            // to the client. The data is then displayed in the "Received"
            // section of the page.
            socket.on('update', function(msg, cb) {
                console.log("GOT UPDATE", msg)
                console.log("DATA:", msg.data)
                $('#log').append('<br>' + $('<div/>').text('Received #' + msg).html());
                if (cb)
                    cb();
                load(msg.room)
            });

            // Interval function that tests message latency by sending a "ping"
            // message. The server then responds with a "pong" message and the
            // round trip time is measured.
            var ping_pong_times = [];
            var start_time;

            // Handlers for the different forms in the page.
            // These accept data from the user and send it to the server in a
            // variety of ways

            var current_room = null;

            function load(fn){
                console.log(`LOAD ${fn}`)
                if(current_room != fn){
                    socket.emit('stopwatch', {room: fn});
                }
                fetch(fn)
                    .then( r => r.text())
                    .then( txt => {
                        console.log("update.....")
                        /* update file content*/
                        e = document.getElementById('file')
                        content = document.createTextNode(txt)

                        while (e.firstChild) {
                            e.removeChild(e.firstChild);
                        }
                        e.appendChild(content)

                        if(current_room != fn){
                            console.log(`watch ${fn}`)
                            socket.emit('watch', {room: fn});
                            current_room = fn
                        }
                    })
                    .catch( e=> {
                        console.log("error:", e)
                    })
            }

            fetch('/_list')
            .then( r => {
                return r.json()
            })
            .then(data => {
                let file
                let ul = document.getElementById('filelist')
                data.forEach( file => {

                    let li = document.createElement("li")
                    let a = document.createElement("a");
                    // a.href = "#"+file;
                    a.onclick = function() {
                        load(file);
                    }
                    a.href="#";
                    a.textContent = file;

                    li.appendChild(a)
                    ul.appendChild(li)

                    //console.log(file)
                    //e.innerHTML += `<li>${file}\n`
                })
            })

        });
    </script>
</head>
<body>
    <h1>Websocket instant webserver (based on Flask-SocketIO Test)</h1>
    
    <h2>Load file:</h2>
    <div>
        <ul id="filelist">
        </ul>
    </div>

    <h2>File:</h2>
    <div id="file"></div>
    
    <h2>Receive:</h2>
    <div id="log"></div>
</body>
</html>
